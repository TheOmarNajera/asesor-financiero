name: Deploy to Azure VM (Arm)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: asesor-pyme-vm
  AZURE_RESOURCE_GROUP: asesor-pyme-rg
  AZURE_LOCATION: westeurope
  AZURE_VM_NAME: asesor-pyme-vm
  AZURE_VM_SIZE: Standard_D2ps_v5
  AZURE_ADMIN_USERNAME: azureuser

jobs:
  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
    
    - name: Install Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        az version
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Create Resource Group
      if: github.ref == 'refs/heads/main'
      run: |
        az group create --name ${{ env.AZURE_RESOURCE_GROUP }} \
          --location ${{ env.AZURE_LOCATION }} \
          --output table
    
    - name: Check if VM exists
      id: check-vm
      run: |
        VM_EXISTS=$(az vm list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query "[?name=='${{ env.AZURE_VM_NAME }}'].name" -o tsv)
        if [ -z "$VM_EXISTS" ]; then
          echo "exists=false" >> $GITHUB_OUTPUT
        else
          echo "exists=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Create VM if not exists
      if: steps.check-vm.outputs.exists == 'false'
      run: |
        echo "Creating new VM with Arm architecture..."
        
        # Generate SSH key pair for the VM
        ssh-keygen -t rsa -b 4096 -f ~/.ssh/vm_key -N ""
        
        # Get the public key
        PUBLIC_KEY=$(cat ~/.ssh/vm_key.pub)
        
        az vm create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_VM_NAME }} \
          --image "Ubuntu2204" \
          --size ${{ env.AZURE_VM_SIZE }} \
          --admin-username ${{ env.AZURE_ADMIN_USERNAME }} \
          --ssh-key-value "$PUBLIC_KEY" \
          --public-ip-sku Standard \
          --location ${{ env.AZURE_LOCATION }} \
          --output table
        
        # Store the private key for later use
        echo "$(cat ~/.ssh/vm_key)" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Open required ports
        az vm open-port --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_VM_NAME }} --port 80 --priority 1000
        az vm open-port --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_VM_NAME }} --port 443 --priority 1001
        az vm open-port --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_VM_NAME }} --port 8000 --priority 1002
    
    - name: Get VM IP
      id: vm-ip
      run: |
        VM_IP=$(az vm show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_VM_NAME }} \
          --show-details \
          --query publicIps \
          --output tsv)
        echo "IP=$VM_IP" >> $GITHUB_OUTPUT
        echo "VM IP: $VM_IP"
    
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # If VM was just created, use the generated key
        if [ ! -f ~/.ssh/id_rsa ]; then
          echo "${{ secrets.AZURE_SSH_KEY }}" > ~/.ssh/id_rsa
        fi
        
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan ${{ steps.vm-ip.outputs.IP }} >> ~/.ssh/known_hosts 2>/dev/null
    
    - name: Install dependencies on VM
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "sudo apt-get update && sudo apt-get upgrade -y"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "command -v docker &> /dev/null || (curl -fsSL https://get.docker.com -o get-docker.sh && sudo sh get-docker.sh && sudo usermod -aG docker $USER && rm get-docker.sh)"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} 'command -v docker-compose &> /dev/null || (sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose && sudo chmod +x /usr/local/bin/docker-compose)'
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "sudo apt-get install -y git openssl"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} 'echo "âœ… Dependencies installed"'
    
    - name: Deploy application to VM
      run: |
        # Create app directory and clone
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
          ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} \
          "mkdir -p ~/asesor-pyme && cd ~/asesor-pyme && git clone https://github.com/${{ github.repository }} . || git pull"
    
    - name: Create .env file on VM
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'HOST=0.0.0.0' > .env"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'PORT=8000' >> .env"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'DEBUG=False' >> .env"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'DEFAULT_EMPRESA_ID=E001' >> .env"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'USE_SAMPLE_DATA=true' >> .env"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'SKIP_EXCEL_LOADING=true' >> .env"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'SNOWFLAKE_ACCOUNT=${{ secrets.SNOWFLAKE_ACCOUNT }}' >> .env"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'SNOWFLAKE_USER=${{ secrets.SNOWFLAKE_USER }}' >> .env"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'SNOWFLAKE_PASSWORD=${{ secrets.SNOWFLAKE_PASSWORD }}' >> .env"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'SNOWFLAKE_WAREHOUSE=COMPUTE_WH' >> .env"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'SNOWFLAKE_DATABASE=PYME_FINANCIAL' >> .env"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'SNOWFLAKE_SCHEMA=PUBLIC' >> .env"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}' >> .env"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} "cd ~/asesor-pyme && echo 'ELEVENLABS_API_KEY=${{ secrets.ELEVENLABS_API_KEY }}' >> .env"
    
    - name: Create SSL certificates
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
          ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} \
          "cd ~/asesor-pyme && mkdir -p ssl && \
           openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
           -keyout ssl/key.pem -out ssl/cert.pem \
           -subj '/CN=localhost'"
    
    - name: Deploy with Docker Compose
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
          ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} \
          "cd ~/asesor-pyme && docker-compose down && docker-compose build && docker-compose up -d"
        
        # Wait for services
        sleep 30
        
        # Check service status
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
          ${{ env.AZURE_ADMIN_USERNAME }}@${{ steps.vm-ip.outputs.IP }} \
          "cd ~/asesor-pyme && docker-compose ps"
    
    - name: Health Check
      run: |
        echo "ðŸŒ Application URL: http://${{ steps.vm-ip.outputs.IP }}"
        echo "ðŸŒ Application URL (HTTPS): https://${{ steps.vm-ip.outputs.IP }}"
        echo "ðŸ“Š API URL: https://${{ steps.vm-ip.outputs.IP }}/api"
        
        # Simple health check with SSL
        curl -k -f https://${{ steps.vm-ip.outputs.IP }}/health || echo "âš ï¸ Health check failed, but deployment may still be in progress"
    
    - name: Deployment Summary
      if: always()
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **VM IP**: ${{ steps.vm-ip.outputs.IP }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Architecture**: Arm (${{ env.AZURE_VM_SIZE }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Application (HTTP)**: http://${{ steps.vm-ip.outputs.IP }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Application (HTTPS)**: https://${{ steps.vm-ip.outputs.IP }}" >> $GITHUB_STEP_SUMMARY

